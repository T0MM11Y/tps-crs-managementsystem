<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<body layout:fragment="content">
	<div class="text-left">
		<h1 class="font-size-22 font-weight-bold" style="color: rgb(89, 89, 89);">序號效期更新</h1>
	</div>
	<div class="container-fluid">
		<div class="row">
			<!-- 第一個表單組：顯示部門別 -->
			<div class="col-md-3">
				<div class="form-group d-flex align-items-center">
					<label class="mb-0 mr-2 col-auto col-form-label font-weight-bold" style="white-space: nowrap;">部門別</label>
					<input type="text" class="form-control" th:value="${session.userInfo.departmentName}" readonly>
				</div>
			</div>
			<!-- 第二個表單組：顯示申請人姓名 -->
			<div class="col-md-3">
				<div class="form-group d-flex align-items-center">
					<label class="mb-0 mr-2 col-auto col-form-label font-weight-bold" style="white-space: nowrap;">申請人姓名</label>
					<input type="text" class="form-control" th:value="${session.userInfo.userName}" readonly>
				</div>
			</div>
			<!-- 第三個表單組：輸入報告ID -->
			<div class="col-md-3">
				<div class="form-group d-flex align-items-center">
					<label class="mb-0 mr-2 col-auto col-form-label font-weight-bold" style="white-space: nowrap;">reportID</label>
					<input type="number" class="form-control" id="reportIdInput">
				</div>
			</div>
			<!-- 第四個表單組：輸入發幣月份 -->
			<div class="col-md-3">
				<div class="form-group d-flex align-items-center">
					<label class="mb-0 mr-2 col-auto col-form-label font-weight-bold" style="white-space: nowrap;">發幣月份</label>
					<input type="month" class="form-control" id="rewardDateInput">
				</div>
			</div>
		</div>
	</div>
	<!-- 查詢按鈕 -->
	<div class="button-row">
		<button type="button" id="search-btn" class="btn btn-primary-blue btnrow-a">查詢</button>
	</div>
	<!-- 表格容器 -->
	<div id="table-container" class="mt-4 table--c">
		<table id="table"></table>
	</div>

	<!-- JavaScript程式碼區塊 -->
	<script>
		$(document).ready(function() {
			// 定義全域變數 selectedRows 用於存儲選中的行
			var selectedRows = {};

			// 定義表格的列結構
			var columns = [
				{
					field: '流水號',
					halign: 'center', // 表頭內容居中
					align: 'center',  // 列內容居中
					formatter: function(value, row, index) {
						return index + 1; // 流水號在前端生成
					}
				},
				{
					field: '編輯按鈕',
					title: '<button type="button" class="btn btn-primary--c btn-sm" id="edit-btn" style="background: red;">編輯</button>',
					halign: 'center',
					align: 'center',
					formatter: function(value, row, index) {
						var checked = selectedRows[row['REPORT_ID']] ? 'checked' : '';
						return '<input type="checkbox" class="edit-checkbox bs-checkbox" data-index="' + index + '" data-id="' + row['REPORT_ID'] + '" ' + checked + '>';
					}
				},
				{
					field: 'REPORT_ID',
					title: 'REPORT ID',
					halign: 'center',
					align: 'center'
				},
				{
					field: 'REWARD_DATE',
					title: '發幣月份',
					halign: 'center',
					align: 'center',
					formatter: function(value) {
						return formatDate(value);
					}
				},
				{
					field: 'AMOUNT_VALIDITY_START_DATE',
					title: '效期起日',
					halign: 'center',
					align: 'center',
					formatter: function(value) {
						return formatDate2(value);
					}
				},
				{
					field: 'AMOUNT_VALIDITY_END_DATE',
					title: '效期訖日',
					halign: 'center',
					align: 'center',
					formatter: function(value) {
						return formatDate2(value);
					}
				}
			];

			// 動態計算表格高度
			function getTableHeight() {
				var h = $('.mainPage-height-small').height() - 100;
				return h;
			}

			// 日期格式化函數，用於格式化發幣月份
			function formatDate(dateStr) {
				if (!dateStr) return '';
				var date = new Date(dateStr);
				var y = date.getFullYear();
				var m = ('0' + (date.getMonth() + 1)).slice(-2);
				return y + m;
			}

			// 日期時間格式化函數，用於格式化效期起訖日
			function formatDate2(dateStr) {
				if (!dateStr) return '';
				let date = new Date(dateStr);
				let year = date.getFullYear();
				let month = ('0' + (date.getMonth() + 1)).slice(-2);
				let day = ('0' + date.getDate()).slice(-2);
				let hours = ('0' + date.getHours()).slice(-2);
				let minutes = ('0' + date.getMinutes()).slice(-2);
				let seconds = ('0' + date.getSeconds()).slice(-2);
				let milliseconds = ('00' + date.getMilliseconds()).slice(-3);
				return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
			}

			// 初始化表格
			$('#table').bootstrapTable('destroy');
			$('#table').bootstrapTable({
				columns: columns,
				data: [],
				pagination: true,
				pageSize: 10, // 每頁顯示10條
				pageList: [10, 25, 50, 100], // 分頁選項
				sidePagination: 'client',
				height: getTableHeight(), // 設定表格高度
				fixedHeader: true, // 固定表頭
				ajax: function(params) {
					// 構建請求參數
					var data = {
						reportId: $('#reportIdInput').val(),
						rewardDate: $('#rewardDateInput').val()
					};
					// 發送AJAX請求獲取資料
					$.ajax({
						type: 'POST',
						url: 'getReportData',
						data: data,
						dataType: 'json',
						success: function(data, textStatus, jqXHR) {
							
							params.success(data, textStatus, jqXHR);
						},
						error: function(xhr, textStatus, errorThrown) {
							params.error(errorThrown);
						}
					});
				}
			});

			// 監聽窗口大小變化，調整表格高度
			$(window).resize(function() {
				$('#table').bootstrapTable('resetView', {
					height: getTableHeight()
				});
			});

			// 監聽分頁大小變化，調整表格高度
			$('#table').on('page-list-change.bs.table', function(e, number, size) {
				$('#table').bootstrapTable('resetView', {
					height: getTableHeight()
				});
			});

			// 表格渲染完畢後調整高度
			$('#table').on('post-body.bs.table', function() {
				$('#table').bootstrapTable('resetView', {
					height: getTableHeight()
				});
			});

			// 表頭“編輯”按鈕點擊事件
			$(document).on('click', '#edit-btn', function() {
				var selectedData = [];
				var allData = $('#table').bootstrapTable('getData', {
					includeHiddenRows: true
				});
				// 收集選中的行數據
				for (var i = 0; i < allData.length; i++) {
					var row = allData[i];
					if (selectedRows[row['REPORT_ID']]) {
						selectedData.push(row);
					}
				}
				if (selectedData.length === 0) {
					// 顯示提示對話框
					$.confirm({
						title: '提醒',
						titleClass: 'text-center d-block font-weight-bold text-warning2',
						content: '您未選取任何reportId。請打勾選擇reportId之後再點擊編輯按鈕。',
						buttons: {
							確定: {
								text: '確定',
								btnClass: 'btn-warning2 text-white',
								action: function() {
									// 點擊“確定”後的操作（可選）
								}
							}
						}
					});
				} else {
					// 顯示日期輸入對話框
					$.confirm({
						title: '請確認欲統一編輯的效期起訖日',
						titleClass: 'text-center d-block font-weight-bold text-warning2',
						content: '' +
							'<div id="error-message" style="color:red; text-align:center;"></div>' +
							'<form>' +
							'<div class="form-group d-flex align-items-center">' +
							'  <label class="mb-0 mr-2" style="white-space: nowrap;">效期起日</label>' +
							'  <input type="date" class="form-control" id="startDate" required />' +
							'</div>' +
							'<div class="form-group d-flex align-items-center">' +
							'  <label class="mb-0 mr-2" style="white-space: nowrap;">效期訖日</label>' +
							'  <input type="date" class="form-control" id="endDate" required />' +
							'</div>' +
							'</form>',
						buttons: {
							取消: {
								text: '取消',
								btnClass: 'btn-custom-cancel',
								action: function() {
									// 點擊“取消”後的操作（可選）
								}
							},
							確認: {
								text: '確認',
								btnClass: 'btn-custom-confirm',
								action: function() {
									var jc = this; // 獲取當前對話框實例
									var startDate = this.$content.find('#startDate').val();
									var endDate = this.$content.find('#endDate').val();

									// 清空之前的錯誤訊息
									this.$content.find('#error-message').html('');

									// 驗證起日和訖日是否填寫
									if (!startDate || !endDate) {
										this.$content.find('#error-message').html('請填寫完整的日期');
										return false; // 阻止對話框關閉
									}

									// 驗證訖日是否小於起日
									if (new Date(endDate) < new Date(startDate)) {
										this.$content.find('#error-message').html('效期訖日不能小於效期起日');
										return false; // 阻止對話框關閉
									}

									// 在此處處理確認後的邏輯，例如發送請求更新資料
									console.log('選擇的效期起日：', startDate);
									console.log('選擇的效期訖日：', endDate);
									console.log('選中的行數：', selectedData.length);
									console.log('選中的行數據：', selectedData);

									// 從 selectedData 中提取 reportIds
									var reportIds = selectedData.map(function(item) {
										return item['REPORT_ID'];
									});

									// 構建請求數據
									var data = {
										reportIds: reportIds, // reportIds 是一個數組
										startDate: startDate,
										endDate: endDate
									};

									// 發送 AJAX 請求
									$.ajax({
										type: 'POST',
										url: 'updateAmountValidityDates',
										data: data,
										traditional: true, // 確保數組參數正確傳遞
										success: function(response) {
											$('#table').bootstrapTable('refresh');
											jc.close();
										},
										error: function(xhr, status, error) {
											this.$content.find('#error-message').html('更新失敗：' + error);
										}
									});
									return false; // 阻止對話框關閉
								}
							}
						},
						onContentReady: function() {
							// 對話框內容準備好後的操作（可選）
						}
					});
				}
			});

			// 查詢按鈕點擊事件
			$('#search-btn').click(function() {
				// 清空選中的行
				selectedRows = {};
				// 刷新表格數據
				$('#table').bootstrapTable('refresh');
			});

			// 監聽復選框變化事件
			$('#table').on('change', '.edit-checkbox', function() {
				var id = $(this).data('id'); // 獲取 REPORT_ID
				if ($(this).is(':checked')) {
					selectedRows[id] = true;
				} else {
					delete selectedRows[id];
				}
			});
		});
	</script>

	<!-- 樣式區塊 -->
	<style>
		.container-fluid {
			position: relative;
			padding: 20px;
		}

		h1 {
			margin: 0;
			padding-bottom: 10px;
		}

		.button-row {
			margin-top: 20px;
			text-align: center;
		}

		/* 表格復選框居中 */
		.bs-checkbox {
			text-align: center !important;
			vertical-align: middle !important;
		}

		/* 調整復選框大小 */
		.edit-checkbox {
			transform: scale(1.5);
			-webkit-transform: scale(1.5);
			-moz-transform: scale(1.5);
			-ms-transform: scale(1.5);
			-o-transform: scale(1.5);
			margin-top: 5px;
			height: 20px;
			width: 20px;
		}

		.fixed-table-body {
			overflow: auto !important;
		}

		.fixed-table-border {
			height: 0px !important;
		}

		.fixed-table-container {
			border-bottom-width: 0px !important;
		}

		/* 自定義“確認”按鈕樣式 */
		.btn-custom-confirm {
			background-color: #ff6100 !important; /* 背景為橙色 */
			color: #fff !important; /* 字體顏色為白色 */
			border: 1px solid #ff6100 !important; /* 邊框顏色為橙色 */
			box-shadow: none !important; /* 去除按鈕陰影 */
		}

		/* 滑鼠懸停時的效果 */
		.btn-custom-confirm:hover {
			background-color: #e65a00 !important; /* 懸停時背景稍微變深 */
			color: #fff !important;
		}

		/* 自定義“取消”按鈕樣式 */
		.btn-custom-cancel {
			background-color: #fff !important; /* 背景為白色 */
			color: #ff6100 !important; /* 文字顏色為橙色 */
			border: 1px solid #ff6100 !important; /* 邊框顏色為橙色 */
			box-shadow: none !important; /* 去除按鈕陰影 */
		}

		/* 滑鼠懸停時的效果 */
		.btn-custom-cancel:hover {
			background-color: #ff6100 !important; /* 懸停時背景變為橙色 */
			color: #fff !important;
		}
	</style>
</body>
</html>
