<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<body layout:fragment="content">
	<div class="text-left">
		<h1 class="display-5">部門列表</h1>
	</div>
	<div class="container-fluid px-3 py-3">
		<form method="post" onsubmit="findDepartmentList()">
			<div class="form-group row justify-content-center">
				<div class="col-lg-4">
					<label class="form-control-label" for="departmentName">部門名稱</label>
					<input type="text" class="form-control" id="departmentName"
						name="departmentName" />
				</div>
			</div>
			<div class="row mt-2">
				<div class="col-lg-12 text-center">
					<button type="button" class="btn btn-secondary"
						onclick="addDepartment()">新增</button>
					<button type="button" class="btn btn-primary--c"
						onclick="findDepartmentList()">查詢</button>
				</div>
			</div>
		</form>
		<div class="card-body-step0-step1-step2-step3">
			<div class="table--c my-4">
				<table class="table--departmentList"></table>
			</div>
		</div>
	</div>
	<script th:inline="javascript">
        $(function() {
        	$('.table--c').on('click', '.btn--editBtn', function() {
        		let arg = $(this).data('id');

        		formSubmit([[@{departmentSetting}]], {departmentId: arg});
        	});

        	$('.table--c').on('click', '.btn--disabledBtn, .btn--enabledBtn', function() {
        		let json = $(this).data('json');

        		callAjax([[@{updateDepartmentStatus}]], json, afterChangeStatus);
        	});
        });

        function findDepartmentList(obj) {
        	obj = obj || $('form').serialize()+'&action=QUERY';

        	callAjax([[@{findDepartment}]], obj, composeTable);
        }

        function composeTable(data) {
        	$('.table--departmentList').bootstrapTable('destroy');

        	$('.table--departmentList').bootstrapTable({
        		columns: [ //欄位設定
        			{field: 'departmentId', title: '部門ID', halign: 'center', align: 'right'},
        			{field: 'departmentName', title: '部門名稱', halign: 'center'},
        			{field: 'enabled', title: '部門狀態', align: 'center', formatter: statusFormatter},
        			{field: '', title: '', align: 'center', formatter: buttonFormatter}
        		],
        		// classes: 'table table-striped table-bordered table-dark',
        		sidePagination: 'server',
        		data: data.result,//資料
        		pagination: true, //是否要分頁
        		pageNumber: data.number, //初始化加載第一頁
        		pageSize: data.size, //一頁顯示幾筆
        		pageList: [10, 20, 50, 100, 'All'], //一頁顯示幾筆的選項
        		totalRows: data.total,
        		// search : true, //查詢
        		checkboxHeader: false,
        		sortName: data.name,
        		sortOrder: data.order,
        		/*onClickRow: function(row, $element, field) {
        			console.log('row: ', row);

        		},*/
        		onSort: function(name, order) {
        			// console.log('name: ' + name + ', order: ' + order);

        			// findDepartmentList({'name': name, 'order': order});
        		},
        		onPageChange: function(number, size) {
        			// console.log('number: ' + number + ', size: ' + size);

        			size = isNaN(size) ? this.totalRows : size;

        			findDepartmentList({'number': number, 'size': size});
        		},
        		onLoadError: function(status, jqXHR) {
        			// console.log('status: ' + status + ', jqXHR: ' + jqXHR);
        		}
        	});
        }

        function statusFormatter(value, row, index) {
        	let elmI = '<i class="' + (row.enabled === 'Y' ? 'bg-success' : 'bg-danger') + '"></i>';

        	let elmSpan = '<span>' + (row.enabled === 'Y' ? '啟動' : '停用') + '</span>';

        	return '<span class="badge badge-dot">' + elmI + elmSpan + '</span>'
        }

        function buttonFormatter(value, row, index) {
        	let editBtn = '<button type="button" class="btn btn-primary--c btn-sm btn--editBtn" data-id="' + row.departmentId + '">編輯</button>';

        	let disabledBtn = '<button type="button" class="btn btn-danger btn-sm ml-2 btn--disabledBtn" data-json=' + JSON.stringify({'departmentId': row.departmentId, 'status': 'N'}) + '>停用</button>';

        	let enabledBtn = '<button type="button" class="btn btn-success btn-sm ml-2 btn--enabledBtn" data-json=' + JSON.stringify({'departmentId': row.departmentId, 'status': 'Y'}) + '>啟用</button>';

        	return editBtn + (row.enabled === 'Y' ? disabledBtn : enabledBtn);
        }

        function afterChangeStatus() {
        	findDepartmentList({});
        }
        
        function addDepartment() {
        	formSubmit([[@{departmentSetting}]]);
        }
    </script>
</body>
</html>
