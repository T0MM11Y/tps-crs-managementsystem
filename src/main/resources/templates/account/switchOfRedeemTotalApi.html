<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<body layout:fragment="content">
	<style>
@media ( min-width :1920px) {
	.fixed-table-body {
		height: 65vh !important;
		width: 100% !important;
	}
}

@media screen and ( min-width :1280px) and ( max-width :1919px) {
	.fixed-table-body {
		width: 100% !important;
		height: 80vh !important;
	}
}

.fixed-table-toolbar {
	margin-top: -10px;
}

#tableid>thead {
	flex: 0 0 auto;
	width: calc(100% - 1.5em) !important;
}

.fixed-table-pagination {
	zoom: 1.3;
}
</style>

	<div class="text-left">
		<h1 class="font-size-22 font-weight-bold"
			style="color: rgb(89, 89, 89);">每月兌幣總額API開關</h1>
	</div>
	<div class="container-fluid px-3 py-3">

		<div class="form-group row"
			style="display: flex; justify-content: left;">
			<label class="col-auto col-form-label font-weight-bold">新增每月兌幣總額API:</label>
		</div>

		<div class="form-group row"
			style="display: flex; justify-content: left;">

			<label class="col-auto col-form-label font-weight-bold">momo公司單位</label>
			<div class="col-lg-4" style="margin-left: 20px;">
				<select name="departmentId" id="departmentId" class="form-control">
					<option value="">請選擇</option>
					<option th:each="department : ${departmentList}"
						th:value="${department.departmentName}"
						th:text="${department.departmentName}"></option>
				</select>
			</div>
			<label class="col-auto col-form-label font-weight-bold">呼叫的API</label>
			<div class="col-lg-6">
				<input type="text" class="form-control" id="apiUrl" name="apiUrl" />
			</div>

		</div>
		<div class="form-group row"
			style="display: flex; justify-content: center;">
			<label class="col-auto col-form-label font-weight-bold mark__required">需求單號</label>
			<div class="col-lg-4">
				<input type="text" class="form-control" id="requestId" name="requestId" />
			</div>

		</div>
		<div class="row mt-2">
			<div class="col-lg-12 text-center">
				<button type="button"
					class="btn btn-primary-blue btnrow-a font-weight-bold font-size-16 btn--insertRow">新增</button>
			</div>
		</div>


		<div class="table--c my-4" style="height: 800px; overflow: auto;">
			<div class="form-group row"
				style="display: flex; justify-content: center;">
				<input type="text" class="form-control w20" id="sn-val"
					placeholder="請輸入查詢關鍵字"> <a href="javascript:;"
					class="btn btn-default btn-sm" id="sn-btn"> <i
					class="fa fa-search"></i>
				</a>
			</div>

			<table class="table--redeemTotalApiList" id="tableid"
				data-resizable="true" data-unique-id="Id"></table>
		</div>

	</div>
	<script th:inline="javascript">
		var searchText = "";
		$(function() {
			findRedeemTotalApiList();
			
			$('#sn-btn').click(function(){
				searchText=$('#sn-val').val();
			    findRedeemTotalApiList({ search: searchText });
			});
			$('#sn-val').on('keyup', function(event) {
	            if (event.keyCode === 13) {
	                searchText = $('#sn-val').val();
	                findRedeemTotalApiList({ search: searchText });
	            }
	        });
			
	    	$('.table--c').on('click', '.btn--remove', function() {
	    		
	    		var moDeptNo = $(this).data('modeptno');//這裡要用小寫才抓的到
	    		var apiUrl = $(this).data('apiurl');//這裡要用小寫才抓的到
	    		var requestId = $('#requestId').val();
	    		
				// 檢查必填字段
	    		if(!validateFields(moDeptNo, apiUrl,requestId)){
	    			alert("請輸入需求單號!");
	    			return;
	    		}
	    		
				$.confirm({
					title : '刪除此筆API',
					titleClass : 'text-center d-block font-weight-bold text-warning2',
					content : '確認要刪除此筆API？',												
					buttons : {
						取消 : {
							text : '取消 ',
							btnClass : 'btn-warning2 text-white',
							action:function() {
							}
						},
						確定 : {
							text : '確定',
							btnClass : 'btn-warning2 text-white',
							action:function() {
								deleteRedeemTotalApi(moDeptNo, apiUrl,requestId);
							}
						}
					}
				});
			
	    	});
	    	
	    	$('.btn--insertRow').on('click', function() {
	    		var departmentId = $('#departmentId').val();
	    		var apiUrl = $('#apiUrl').val();
	    		var requestId = $('#requestId').val();

				// 檢查必填字段
	    		if(!validateFields(departmentId, apiUrl, requestId)){
	    			alert("請輸入momo公司單位、API、需求單號!");
	    			return;
	    		}
				$.confirm({
					title : '新增API',
					titleClass : 'text-center d-block font-weight-bold text-warning2',
					content : '確認要新增此筆API？',												
					buttons : {
						取消 : {
							text : '取消 ',
							btnClass : 'btn-warning2 text-white',
							action:function() {
							}
						},
						確定 : {
							text : '確定',
							btnClass : 'btn-warning2 text-white',
							action:function() {
								insertRedeemTotalApi(departmentId, apiUrl,requestId);
							}
						}
					}
					
				});

	    		
	    	});
		
		});
		
		function deleteRedeemTotalApi(moDeptNo, apiUrl,requestId) {
			$.ajax({
	        	url : 'deleteRedeemTotalApi',
	            type : "POST",
	            data : {
	                'moDeptNo': moDeptNo,
	                'apiUrl': apiUrl,
	                'requestId': requestId
	            },
	            beforeSend : function() {
	    			openLoading();
	    		},
	    		complete : function() {
	    			closeLoading();
	    		},
	    		success : function(data) {
	    			
	    			if (data.code === '998') {
	    				showError(data.errorMessages);
	    			} else if (data.code === '000') {
	    				messagePopup(data.message);

	    				if (findRedeemTotalApiList) {
	    					findRedeemTotalApiList();
	    				}
	    			} else if (findRedeemTotalApiList) {
	    				findRedeemTotalApiList({ search: searchText });
	    			}
	    		},
	    		error : function(e) {
	    			errorMessagePopup(e.responseJSON.message);
	    		}
	        });
        }
		
		function insertRedeemTotalApi(departmentId, apiUrl,requestId){
			$.ajax({
	        	url : 'insertRedeemTotalApi',
	            type : "POST",
	            data : {
	                'departmentId': departmentId,
	                'apiUrl': apiUrl,
	                'requestId' : requestId
	            },
	            beforeSend : function() {
	    			openLoading();
	    		},
	    		complete : function() {
	    			closeLoading();
	    		},
	    		success : function(data) {
	    			
	    			if (data.code === '998') {
	    				showError(data.errorMessages);
	    			} else if (data.code === '000') {
	    				messagePopup(data.message);

	    				if (findRedeemTotalApiList) {
	    					findRedeemTotalApiList();
	    				}
	    			} else if (findRedeemTotalApiList) {
	    				findRedeemTotalApiList();
	    			}
	    		},
	    		error : function(e) {
	    			//errorMessagePopup(e.responseJSON.message);
	    			errorMessagePopup("新增錯誤!請檢查是否重複寫入!");
	    		}
	        });
		}
		
		function findRedeemTotalApiList(obj) {
        	obj = obj || $('form').serialize()+'&action=QUERY';
            if (searchText !== "") {
                obj.search = searchText;
            }
            
        	callAjax([[@{switchOfRedeemTotalApi}]], obj, composeTable);
        	
        }
		
		function composeTable(data) {
			$('.table--redeemTotalApiList').bootstrapTable('destroy');
			$('.table--redeemTotalApiList').bootstrapTable({
	    		columns: [ //欄位設定
	    			//{field: 'Id', title: '',class:"w3"  ,align: 'center'}, 
	    			{field: '', title: '',class:"w2"  ,align: 'center',formatter: buttonFormatter },
	    			{field: 'moDeptNo',class:"w7", title: 'momo公司單位',   align: 'center', sortable:true},
	    			{field: 'apiUrl', title: '呼叫的API',class:"w7",   align: 'center', sortable:true},
	    		],

	    		sidePagination: 'server',
	    		data: data.result,//資料
	    		pagination: true, //是否要分頁
	    		pageNumber: data.number, //初始化加載第一頁
	    		pageSize: data.size, //一頁顯示幾筆
	    		pageList: [10, 25, 50, 100,'All'], //一頁顯示幾筆的選項
	    		totalRows: data.total,
	    		//search : true,
	    		//searchOnEnterKey : true,
	    		//showSearchClearButton: true,
	    		//showRefresh: true, // 关闭 Bootstrap Table 默认的刷新按钮
	    		checkboxHeader: false,
	    		sortName: data.name,
        		sortOrder: data.order,
        		onSort: function(name, order) {
        			findRedeemTotalApiList({'name': name, 'order': order});
        		},
        		onPageChange: function(number, size) {
        			size = isNaN(size) ? this.totalRows : size;
        			findRedeemTotalApiList({'number': number, 'size': size});
        		},
        		onLoadError: function(status, jqXHR) {
        			// console.log('status: ' + status + ', jqXHR: ' + jqXHR);
        		}
        		/*onSearch: function (text) {
        	        // 调用后端接口，传递搜索关键字
        	        searchText = $('.table--redeemTotalApiList').bootstrapTable('getOptions').searchText;
        	        findRedeemTotalApiList({ search: text });
        	    },
        	    onRefresh:function(params)
                {
        	    	searchText = "";
        	    	findRedeemTotalApiList({ search: '' });
                },*/
                
	    	});
		}
		
	    function buttonFormatter(value, row, index) {
	    	let btn = '<button type="button" class="btn bg-danger text-white ml-2 btn-sm font-weight-bold btn--remove"  data-moDeptNo="'+row.moDeptNo+'" data-apiUrl="'+row.apiUrl+'">刪除</button>';
	    	return btn;
	    }
	    
		function validateFields(...fields) {
			for (const field of fields) {
				if (!field || field.trim() === '') {
					return false;
				}
			}
			return true;
		}
	 	
	</script>
</body>
</html>
