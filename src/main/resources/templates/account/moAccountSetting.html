<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<body layout:fragment="content">
	<div class="text-left">
		<h1 class="display-5">[[${vo.action.isAdd() ? '新增' :
			'編輯'}]]MO幣系統帳號</h1>
	</div>
	<div class="container-fluid px-3 py-3">
		<form method="post">
			<h6 class="heading-small text-muted mb-4">基本資訊</h6>
			<div class="pl-lg-4">
				<div class="row">
					<div class="col-lg-6">
						<div class="form-group">
							<label class="form-control-label mark__required"
								for="departmentId">部門別/服務群組</label> <select class="form-control"
								id="departmentId" name="departmentId"
								th:disabled="${vo.action.isEdit()}">
								<option value="">請選擇</option>
								<option th:each="department : ${departmentList}"
									th:value="${department.departmentId}"
									th:text="${department.departmentName}"
									th:selected="${department.departmentId eq vo.departmentId}"></option>
							</select> <input type="hidden" name="departmentId"
								th:value="${vo.departmentId}" th:if="${vo.action.isEdit()}" />
						</div>
					</div>
					<div class="col-lg-6">
						<div class="form-group">
							<label class="form-control-label mark__required" for="email">MO幣系統窗口</label>
							<select class="form-control" id="contactAccountId"
								name="contactAccountId">
								<option value="">請選擇</option>
							</select>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-6">
						<div class="form-group">
							<label class="form-control-label mark__required" for="merchantId">MOMO廠商代碼</label>
							<input type="text" class="form-control" id="merchantId"
								name="merchantId" maxlength="15" th:value="${vo.merchantId}"
								th:readonly="${vo.action.isEdit()}" />
						</div>
					</div>
					<div class="col-lg-6">
						<div class="form-group">
							<label class="form-control-label mark__required" for="deptNo">MOMO公司單位</label>
							<input type="text" class="form-control" id="deptNo" name="deptNo"
								maxlength="4" th:value="${vo.deptNo}"
								th:readonly="${vo.action.isEdit()}" />
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-6">
						<div class="form-group">
							<label class="form-control-label mark__required" for="merchantId">MOMO
								API KEY</label> <input type="text" class="form-control" id="apiKey"
								name="apiKey" th:value="${vo.apiKey}" />
						</div>
					</div>
					<div class="col-lg-6">
						<div class="form-group">
							<label class="form-control-label mark__required"
								for="encryptedKey">MOMO 資料加密 KEY</label> <input type="text"
								class="form-control" id="encryptedKey" name="encryptedKey"
								th:value="${vo.encryptedKey}" />
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-6">
						<div class="form-group">
							<label class="form-control-label mark__required" for="requestId">需求單號</label>
							<input type="text" class="form-control" id="requestId" name="requestId" maxlength="100"
								th:value="${vo.requestId}" />
						</div>
					</div>
				</div>
			</div>
			<div class="col-lg-12">
				<div class="row justify-content-center">
					<input type="hidden" name="action" th:value="${vo.action}" />
					<button type="button" class="btn btn-primary"
						th:onclick="'callAjax(\'' + @{saveMOAccountSetting} + '\', null, confirmMsg)'">儲存</button>
				</div>
			</div>
		</form>
	</div>

	<script th:inline="javascript">
    $(function() {
    	$('#departmentId').on('change', function() {
    		findDepartmentAccountList();
    	});
    	
    	findDepartmentAccountList();
    });

    function confirmMsg() {
    	let contentDiv = $('#messageModal .modal-content');
    	
    	let footerDiv = $('<div>').prop('class', 'modal-footer');
    	
    	let continueBtn = $('<button>').prop('class', 'btn btn-secondary').attr('onclick', 'gotoPage([[@{moAccountSetting}]])').html('繼續新增');
    	
    	let redirectBtn = $('<button>').prop('class', 'btn btn-primary').attr('onclick', 'gotoPage([[@{findMOAccount}]])').html('回MO幣系統帳號列表');
    	
    	contentDiv.append(footerDiv.append(continueBtn).append(redirectBtn));
    	
    	$('#messageModal').on('hidden.bs.modal', function() {
    		$(this).find('.modal-body').empty();
    		
    		gotoPage([[@{findAccount}]]);
    	});
    }
    
    function findDepartmentAccountList() {
    	let departmentId = $('#departmentId').val();
    	
    	if(!isNull(departmentId)) {
    		callAjax([[@{findDepartmentAccountList}]], {'departmentId': departmentId}, composeAccount);
    	}
    }
    
    function composeAccount(data) {
    	let elm = $('#contactAccountId');
    	
    	elm.find('option').not(':first').remove();
    	
    	if(data) {
    		for(let i in data) {
    			let option = $('<option>').prop('value', data[i].accountId).prop('text', data[i].userName);
    			
    			elm.append(option);
    		}
    		
    		if(data.length === 1) {
    			elm.find('option:eq(1)').attr('selected', true);
    		}
    		
    		[# th:if="${vo.contactAccountId ne null}"]
    		elm.val([[${vo.contactAccountId}]]);
    		[/]
    	}
    }
    </script>
</body>
</html>